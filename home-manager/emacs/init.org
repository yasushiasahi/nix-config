#+TITLE: My Configuration for GNU Emacs
#+AUTHOR: Yasushi Asahi
#+EMAIL: asahi1600@gmail.com
#+STARTUP: content

* 最初に行うべき
** package.ei 標準パッケージマネージャー
外部パッケージのソースはすべてnixで入れているのでミニマムでやる気ない設定。
[[https://qiita.com/nobuyuki86/items/e392b642189d755dd113#packageel][このような]]凝った設定もある。「built-inパッケージも更新対象にする」が気になる。
#+begin_src emacs-lisp :tangle yes
  (require 'package)
  (package-initialize)
  (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/"))
#+end_src
** [[https://github.com/conao3/leaf.el][leaf.el]] オルタナティブuse-package
#+begin_src emacs-lisp :tangle yes
(use-package leaf :ensure t)
#+end_src
** [[https://github.com/purcell/exec-path-from-shell][exec-path-from-shell]] Shellの環境変数をEmacsに同期する
#+begin_src emacs-lisp :tangle yes
  (use-package exec-path-from-shell
    :ensure t

    :custom
    ;; デフォルは"-i"。シェルをインタラクティブに起動すると時間かかるので引数なしにする。
    ;; https://github.com/purcell/exec-path-from-shell?tab=readme-ov-file#making-exec-path-from-shell-faster
    (exec-path-from-shell-arguments nil)
    ;; どの環境変数を取り込むか
    (exec-path-from-shell-variables '("PATH" "LSP_USE_PLISTS"))

    :config
    (exec-path-from-shell-initialize))
#+end_src


* Emacs組み込み機能の設定、有効化
** customize set variable結果の置き場所指定
tangleした後のinit.elなら書き込んでくれても良いが。nix/store/ファイルに書き込むことはおそらくできない。
#+begin_src emacs-lisp :tangle yes
(setopt custom-file (locate-user-emacs-file "custom.el"))
#+end_src
** バックアップファイル（自動生成ファイル）
- 自動保存リストファイル
  - 自動保存ファイル(auto-save-file)のリスト？
  - 8年Emacsを使ってきて見ようと思ったことがないので不要
#+begin_src emacs-lisp :tangle yes
  ;; 編集中のファイルを定期的に保存してバックアップとして残す（自動保存ファイル）。-> ~/.config/emacs/buckup/
  (setopt auto-save-file-name-transforms `((".*" ,(locate-user-emacs-file "backup/") t)))

  ;; ファイルオープン時(編集前)のファイルをバックアップとして残す。-> ~/.config/emacs/buckup/
  (setopt backup-directory-alist `((".*" . ,(locate-user-emacs-file "backup"))))

  ;; 自動保存リストファイルは作成しない
  (setopt auto-save-list-file-prefix nil)

  ;; 予めバックアップファイルを納めるディレクトリを作っておく
  (make-directory (locate-user-emacs-file "backup") t)
#+end_src
** ロックファイル
- ロックファイル
  - 共同編集中のファイルの更新競合を防ぐのが重な目的
  - Emacsでファイルを共同編集することはないので不要
#+begin_src emacs-lisp :tangle yes
  ;; ロックファイルは作成しない
  (setopt create-lockfiles nil)
#+end_src
** ビルトインの設定
#+begin_src emacs-lisp :tangle yes
  ;; タブの幅。各言語のモードのタブはばは別でそのモードの設定でそれぞれ設定しないといけない。
  (setopt tab-width 2)

  ;; yesと打たずにyだけで答える
  (defalias 'yes-or-no-p 'y-or-n-p)

  ;; 警告音（ピープ音）をならさい
  (setopt ring-bell-function 'ignore)

  ;; read-onlyなテキストをkilしようとしても警告を表示しない
  (setopt kill-read-only-ok t)

  ;; 行頭でC-k(kill-line)したときにその行自体を消す
  (setopt kill-whole-line nil)

  ;; タブ文字を使用しない
  ;; ちなみに、untabifyでバッファ無いの全てのタブをスペースに置き換えられる。tabifyはその逆。
  (setq-default indent-tabs-mode nil)
#+end_src
** キーバインド
| C-h | バックスペース           |
| M-h | 単語単位のバックスペース |
| C-d | デリート                 |
| M-d | 単語単位のデリート       |
#+begin_src emacs-lisp :tangle yes
  ;; https://www.emacswiki.org/emacs/BackspaceKey
  (define-key key-translation-map [?\C-?] [?\C-h])
  (define-key key-translation-map [?\M-\d] [?\M-h])
  (define-key key-translation-map [?\C-h] [?\C-?])
  (define-key key-translation-map [?\M-h] [?\M-\d])
#+end_src

| C-a | 行頭、文頭に行き来する |
#+begin_src emacs-lisp :tangle yes
  (defun my/beginning-of-line-text-or-line ()
    "行の最初の文字の位置に移動。すでに最初の文字だったら行頭に移動。"
    (interactive)
    (let ((curr-point (point))            ; コマンド実行前のカーソル位置
          (curr-column (current-column))) ; コマンド実行前の行番号
      (back-to-indentation)               ; 一旦行の最初の文字の位置に移動
      (when (and (/= curr-column 0)       ; 元々行頭にいなかった
                 (<= curr-point (point))) ; 最初の文字の位置よりも前にいた
        (beginning-of-line))))            ; その場合は行頭に移動

  (define-key global-map (kbd "C-a") #'my/beginning-of-line-text-or-line)
#+end_src

| C-g | 汎用キャンセル |
#+begin_src emacs-lisp :tangle yes
  ;; 関数名とコメント以外はそのまま使わせていただいている
  ;; https://protesilaos.com/codelog/2024-11-28-basic-emacs-configuration/#h:83c8afc4-2359-4ebe-8b5c-f2e5257bdda3
  (defun my/keyboard-quit-dwim ()
    "一般的な `keyboard-quit' のための「意図を汲んだ」動作。

  汎用的な `keyboard-quit' は、ミニバッファが開いているときに
  期待される動作をしません。私たちが望むのは、明示的にフォーカスを
  当てなくても、ミニバッファを閉じることです。

  このコマンドのDWIM動作は以下の通りです：

  - リージョンがアクティブな場合、それを無効化する。
  - ミニバッファが開いているがフォーカスされていない場合、ミニバッファを閉じる。
  - Completionsバッファが選択されている場合、それを閉じる。
  - その他すべての場合は、通常の `keyboard-quit' を使用する。"
    (interactive)
    (cond
     ((region-active-p)
      (keyboard-quit))
     ((derived-mode-p 'completion-list-mode)
      (delete-completion-window))
     ((> (minibuffer-depth) 0)
      (abort-recursive-edit))
     (t
      (keyboard-quit))))

  (define-key global-map (kbd "C-g") #'my/keyboard-quit-dwim)
#+end_src
** スタートアップメッセージ（ [[https://github.com/tkf/emacs-request][request]] HTTPクライアント）
#+begin_src emacs-lisp :tangle yes
  (use-package request :ensure t)

  (defun display-startup-echo-area-message ()
    "スタートアップメッセージとして名言を表示する"
    (request "https://meigen.doodlenote.net/api/json.php"
      :parser 'json-read
      :success (cl-function
                (lambda (&key data &allow-other-keys)
                  (let* ((item (aref data 0))
                         (meigen (alist-get 'meigen item))
                         (auther (alist-get 'auther item)))
                    (message "%s\nby %s" meigen auther))))))
#+end_src
#+begin_src emacs-lisp :tangle no
  ;; 表示を高速化しようと頑張った残骸
  ;; (setq my/startup-msg nil)
  ;;
  ;; (request "https://meigen.doodlenote.net/api/json.php"
  ;;   :parser 'json-read
  ;;   :success (cl-function
  ;;             (lambda (&key data &allow-other-keys)
  ;;               (let* ((item (aref data 0))
  ;;                      (meigen (alist-get 'meigen item))
  ;;                      (auther (alist-get 'auther item)))
  ;;                 (setq my/startup-msg (format "%s\nby %s" meigen auther))))))
  ;;
  ;; (defun display-startup-echo-area-message ()
  ;;   "スタートアップメッセージとして名言を表示する"
  ;;   (let ((count 0))
  ;;     (while (and (not my/startup-msg) (< count 6))
  ;;       (sleep-for 0.25)
  ;;       (setq count (1+ count)))
  ;;     (message my/startup-msg)))
#+end_src
** recentf - 開いたファイルの履歴を保存
#+begin_src emacs-lisp :tangle yes
  (use-package recentf
    :hook ((emacs-startup . recentf-mode))

    :config
    ;; 履歴の最大数
    (setopt recentf-max-saved-items 1024)

    ;; 履歴に含めたくないファイル
    (add-to-list 'recentf-exclude "~/.config/")
    (add-to-list 'recentf-exclude "/nix/store/")
    (add-to-list 'recentf-exclude "/node_modules/"))
#+end_src
** delsel - 選択状態で入力した時に選択箇所を削除する
#+begin_src emacs-lisp :tangle yes
  (use-package delsel
    :config
    (delete-selection-mode))
#+end_src
** autorevert - emacs外で表示中のfileが更新された時にbufferを再描画する
#+begin_src emacs-lisp :tangle yes
  (use-package autorevert
    :config
    ;; https://github.com/stevemolitor/claude-code.el?tab=readme-ov-file#tips-and-tricks
    (setopt auto-revert-use-notify nil)

    (global-auto-revert-mode 1))
#+end_src
** face-remap - 一時的なフォントサイズを変更
普段は限界までフォントサイズを小さくしているが、画面共有などで他人にEmacsを見てもらう時に便利。
以前までは、C-<wheel-up>, C-<wheel-down>で変更していたけど、これだとバッファローカルになる。
グローバルに変更するにはvim-jpで見かけた以下をやる。
mouse-wheel-global-text-scale。 C-M-<wheel-up>, C-M-<wheel-down> でもサイズ変更できる。
#+begin_src emacs-lisp :tangle yes
  (use-package face-remap
    :bind (("C-x M-=" . global-text-scale-adjust)
           ("C-x M-0" . global-text-scale-adjust)
           ("C-x M-+" . global-text-scale-adjust)
           ("C-x M--" . global-text-scale-adjust))

    :config
    (setopt text-scale-mode-step 2))
#+end_src
** project - プロジェクト管理
#+begin_src emacs-lisp :tangle yes
  (use-package project
    :config
    ;; 指定したファイルがあるディレクトリをプロジェクトのルートとして扱う
    (setopt project-vc-extra-root-markers '(".dir-locals-2.el" ".dir-locals.el" ".envrc")))
#+end_src

* 他から依存されるパッケージ
** [[https://www.gnu.org/software/emacs/manual/html_mono/transient.html][transient]] - 説明むずい。キーリピート的な？
magitの内部的に使われているということはビルトインなの？よく分かってない。
#+begin_src emacs-lisp :tangle yes
  (use-package transient
    :ensure t)
#+end_src
* 見た目
** [[https://github.com/bbatsov/solarized-emacs][solarized-theme]] 定番のカラーテーマ
#+begin_src emacs-lisp :tangle yes
  (use-package solarized-theme
    :ensure t

    :custom
    ;; flycheckなどの警告表示を抑えめに表示する
    (solarized-emphasize-indicators nil)
    ;; 太字を多用しない
    (solarized-use-less-bold t)

    :config
    (load-theme 'solarized-dark t))
#+end_src
** [[https://github.com/eki3z/mini-echo.el][mini-echo]] モードラインを非表示にして、echoエリアで最低限の情報表示をする
#+begin_src emacs-lisp :tangle yes
  (use-package mini-echo
    :ensure t

    :config
    (mini-echo-mode))
#+end_src
** [[https://github.com/protesilaos/pulsar][pulsar]] バッファが書き換わった場所を強調表示する
#+begin_src emacs-lisp :tangle yes
  (use-package pulsar
    :ensure t

    :init
    (pulsar-global-mode 1)

    :config
    (add-hook 'minibuffer-setup-hook #'pulsar-pulse-line)
    (add-hook 'consult-after-jump-hook #'pulsar-recenter-top)
    (add-hook 'consult-after-jump-hook #'pulsar-reveal-entry)
    (add-hook 'imenu-after-jump-hook #'pulsar-recenter-top)
    (add-hook 'imenu-after-jump-hook #'pulsar-reveal-entry))
#+end_src
** [[https://github.com/rainstormstudio/nerd-icons.el?tab=readme-ov-file#installing-fonts][nerd-icons]] Nerdアイコンを扱いやすくする
#+begin_src emacs-lisp :tangle yes
  (use-package nerd-icons
    :ensure t

    :custom
    ;; デフォルトの設定が"Symbols Nerd Font Mono"。
    ;; nix-darwinでインストールしないといけないので明示的書いている。
    ;; https://github.com/rainstormstudio/nerd-icons.el?tab=readme-ov-file#installing-fonts
    (nerd-icons-font-family "Symbols Nerd Font Mono"))
#+end_src
** [[https://github.com/rainstormstudio/nerd-icons-dired][nerd-icons-dired]] DiredにNerdアイコンを表示する
#+begin_src emacs-lisp :tangle yes
  (use-package nerd-icons-dired
    :ensure t

    :hook
    (dired-mode . nerd-icons-dired-mode))
#+end_src
** [[https://github.com/mickeynp/ligature.el][ligature]] Maple Monoフォントのリガチャを設定する
#+begin_src emacs-lisp :tangle yes
  (use-package ligature
    :ensure t

    :config
    ;; 書き方の参考
    ;; https://github.com/mickeynp/ligature.el/wiki
    ;; 対象のリガチャされる文字列。"0xA12 0x56 1920x1080"と"\\ \\' \\."は多分書き方間違ってる。
    ;; https://github.com/subframe7536/maple-font/blob/variable/source/features/README.md#ligatures
    (ligature-set-ligatures 'prog-mode
                            '("::"      "?."                    "<#--"
                              ":::"     "..<"                   "<!---->"
                              "?:"      ".="                    "<->"
                              ":?"      "<~"                    "<-->"
                              ":?>"     "~>"                    "->"
                              "<:"      "~~"                    "<-"
                              ":>"      "<~>"                   "-->"
                              ":<"      "<~~"                   "<--"
                              "<:<"     "~~>"                   ">->"
                              ">:>"     "-~"                    "<-<"
                              "__"      "~-"                    "|->"
                              "#{"      "~@"                    "<-|"
                              "#["      "~~~~~~~"               "-------"
                              "#("      "0xA12 0x56 1920x1080"  ">--"
                              "#?"      "<>"                    "--<"
                              "#!"      "</"                    "<|||"
                              "#:"      "/>"                    "|||>"
                              "#="      "</>"                   "<||"
                              "#_"      "<+"                    "||>"
                              "#__"     "+>"                    "<|"
                              "#_("     "<+>"                   "|>"
                              "]#"      "<*"                    "<|>"
                              "#######" "*>"                    "_|_"
                              "<<"      "<*>"                   "[TRACE]"
                              "<<<"     ">="                    "[DEBUG]"
                              ">>"      "<="                    "[INFO]"
                              ">>>"     "<=<"                   "[WARN]"
                              "{{"      "==>"                   "[ERROR]"
                              "}}"      "=="                    "[FATAL]"
                              "{|"      "==="                   "[TODO]"
                              "|}"      "!="                    "[FIXME]"
                              "{{--"    "!=="                   "[NOTE]"
                              "{{!--"   "=/="                   "[HACK]"
                              "--}}"    "=!="                   "[MARK]"
                              "[|"      "|="                    "[EROR]"
                              "|]"      "<=>"                   "[WARNING]"
                              "!!"      "<==>"                  "todo))"
                              "||"      "<=="                   "fixme))"
                              "??"      "==>"                   "Cl"
                              "???"     "=>"                    "al"
                              "&&"      "<=|"                   "cl"
                              "&&&"     "|=>"                   "el"
                              "//"      "=<="                   "il"
                              "///"     "=>="                   "tl"
                              "/*"      "======="               "ul"
                              "/**"     ">=<"                   "xl"
                              "*/"      ":="                    "ff"
                              "++"      "=:"                    "tt"
                              "+++"     ":=:"                   "all"
                              ";;"      "=:="                   "ell"
                              ";;;"     "\\ \\' \\."            "ill"
                              ".."      "--"                    "ull"
                              "..."     "---"                   "ll"
                              ".?"      "<!--"))

    (global-ligature-mode t))

#+end_src
* ユーティリティー
** [[https://codeberg.org/ideasman42/emacs-undo-fu][undo-fu]] Undo/Redoの改善
何やら[[https://qiita.com/nobuyuki86/items/e392b642189d755dd113#undo-%E3%82%A2%E3%83%B3%E3%83%89%E3%82%A5%E9%96%A2%E9%80%A3][Emacs組み込みのUndoが改善されたらしい]]ので一旦向こうか
#+begin_src emacs-lisp :tangle no
  (use-package undo-fu
    :ensure t

    :custom
    ;; Emacsのデフォルトのクリップボード履歴の容量が小さすぎるらしく、大きくしている。
    ;; https://codeberg.org/ideasman42/emacs-undo-fu#undo-limits
    (undo-limit . 67108864)
    (undo-strong-limit . 100663296)
    (undo-outer-limit . 1006632960)

    :config
    (global-set-key (kbd "C-/")   'undo-fu-only-undo)
    (global-set-key (kbd "C-?") 'undo-fu-only-redo))
#+end_src
** [[https://github.com/casouri/vundo][vando]] キルリングのツリー操作
#+begin_src emacs-lisp :tangle yes
  (use-package vundo
    :ensure t

    :custom
    ;; ツリーの見た目が少しだけ可愛くなる
    (vundo-glyph-alist vundo-unicode-symbols)

    :bind ("C-M-/" . vundo))
#+end_src
** [[https://github.com/Wilfred/helpful][Helpful]] より見やすい*help*
バッファー
#+begin_src emacs-lisp :tangle yes
  (leaf helpful
    :doc "A better *help* buffer"
    :ensure t
    :bind (([remap describe-function] . helpful-callable)
           ([remap describe-variable] . helpful-variable)
           ([remap describe-key]      . helpful-key)
           ([remap describe-command] . helpful-command)
           ([remap Info-goto-emacs-command-node] . helpful-function)
           ("C-c C-d" . helpful-at-point)))
#+end_src
*** describe-*した時*HELP*バッファのウィンドウにフォーカスする。
こうしておくとqですぐに閉じられる。
この設定をまではわざわざ*HELP*のウィンドウまで移動しないと閉じられなくて、気軽にdescribe-*できなかった。
#+begin_src emacs-lisp :tangle yes
  (leaf help
    :doc "help commands for Emacs"
    :tag "builtin" "internal" "help"
    :require t
    :config
    (setopt help-window-select t))
#+end_src
** ウィンドウ操作を直感的に
#+begin_src emacs-lisp :tangle yes
  (transient-define-prefix my/window-operation ()
    "Window Operation"
    :transient-suffix     'transient--do-stay
    :transient-non-suffix 'transient--do-exit
    [:class transient-columns
            ["Move"
             ("p" "↑" windmove-up)
             ("n" "↓" windmove-down)
             ("b" "←" windmove-left)
             ("f" "→" windmove-right)]
            ["Ajust"
             ("<up>" "↑" shrink-window)
             ("<down>" "↓" enlarge-window)
             ("<left>" "←" shrink-window-horizontally)
             ("<right>" "→" enlarge-window-horizontally)]
            ["Split"
             ("\\" "vertical" split-window-right)
             ("-" "horizontal" split-window-below)
             ("s" "swap" window-swap-states)
             ("e" "balance" balance-windows)]
            ["Ohter"
             ("0" "delete" delete-window)
             ("1" "only" delete-other-windows)
             ("t" "maxmaiz" toggle-frame-maximized)]])

  (put 'my/window-operation 'interactive-only nil)

  (define-key global-map (kbd "C-t") #'my/window-operation)
#+end_src
** which-key キーバインドの候補表示
#+begin_src emacs-lisp :tangle yes
  (use-package which-key
    :ensure t

    :config
    (which-key-mode))
#+end_src
** [[http://github.com/szermatt/visual-replace][visual-replace]] 置換インターフェイス
#+begin_src emacs-lisp :tangle yes
  (use-package visual-replace
    :ensure t

    :config
    (visual-replace-global-mode 1))
#+end_src
** 括弧
*** 対応する括弧を自動挿入
#+begin_src emacs-lisp :tangle yes
  (leaf elec-pair
    :config
    (electric-pair-mode))
#+end_src
*** 括弧を賢く扱う [[https://github.com/AmaiKinono/puni][puni]]
#+begin_src emacs-lisp :tangle yes
  (leaf puni
    :ensure t
    :require t
    :bind (:puni-mode-map
           ("C-)" . puni-slurp-forward)
           ("C-}" . puni-barf-forward)
           ("M-(" . puni-wrap-round)
           ("M-s" . puni-splice)
           ("M-r" . puni-raise)
           ("M-U" . puni-splice-killing-backward)
           ("M-z" . puni-squeeze))
    :config
    (puni-global-mode))
#+end_src
** eldoc
*** eldocの内容をchild frameに表示する [[https://github.com/casouri/eldoc-box][eldoc-box]]
#+begin_src emacs-lisp :tangle yes
  (leaf eldoc-box
    :ensure t
    :custom ((eldoc-box-clear-with-C-g . t))
    :bind (("C-c d" . eldoc-box-help-at-point))
    :config
    (setopt eldoc-box-clear-with-C-g t)
    ;; lsp-proxyを使っている分にはこの設定不要かもしれない
    (add-hook 'eldoc-box-buffer-setup-hook #'eldoc-box-prettify-ts-errors 0 t))
#+end_src
** [[https://github.com/Fanael/rainbow-delimiters][rainbow-delimiters]] - 対応する括弧ごとに色をつける
#+begin_src emacs-lisp :tangle yes
  (use-package rainbow-delimiters
    :ensure t

    :hook (prog-mode . rainbow-delimiters-mode))
#+end_src
** [[https://github.com/abo-abo/avy][avy]] - 劇的にカーソル移動を早くする
[[https://emacs-jp.github.io/tips/avy-can-do-anything][Avyならなんでもできる]]
#+begin_src emacs-lisp :tangle yes
  (leaf avy
    :ensure t
    :bind (("C-s" . avy-goto-char-timer))
    :config
    (setopt avy-background t))
#+end_src
** [[https://github.com/akicho8/string-inflection][string-inflection]] - Caseをいい感じに操作する
#+begin_src emacs-lisp :tangle yes
  (use-package string-inflection
    :ensure t
    :after transient

    :bind ("M-i" . my/string-inflection-operation)

    :config
    (transient-define-prefix my/string-inflection-operation ()
      "Window Operation"
      :transient-suffix 'transient--do-exit
      [:class transient-columns
              ["Single word"
               ("u" "EMACS" upcase-word)
               ("d" "emacs" downcase-word)
               ("c" "Emacs" capitalize-word)]
              ["Mulchple Words"
               ("m" "FooBar" string-inflection-camelcase)
               ("l" "fooBar" string-inflection-lower-camelcase)
               ("u" "foo_bar" string-inflection-underscore)
               ("p" "Foo_Bar" string-inflection-capital-snake-case)
               ("s" "FOO_BAR" string-inflection-upcase)
               ("k" "foo-bar" string-inflection-kebab-case)]
              ["Cycle"
               ("a" "cycle" string-inflection-all-cycle)]]))
#+end_src
** yasnippet
#+begin_src emacs-lisp :tangle yes
  (leaf yasnippet
    :doc "Yet another snippet extension for Emacs"
    :url "http://github.com/joaotavora/yasnippet"
    :ensure t
    :config
    (yas-global-mode 1)

    (leaf yasnippet-snippets
      :doc "Collection of yasnippet snippets"
      :url "https://github.com/AndreaCrotti/yasnippet-snippets"
      :ensure t))
#+end_src
** flymake
#+begin_src emacs-lisp :tangle no
  (leaf flymake
    :doc "A universal on-the-fly syntax checker"
    :tag "builtin"
    :hook (prog-mode-hook conf-mode-hook))
#+end_src
** シンタックスチェッカー [[https://www.flycheck.org][flycheck]]
#+begin_src emacs-lisp :tangle yes
  (leaf flycheck
    :ensure t
    :hook ((after-init-hook . global-flycheck-mode)))
#+end_src
** emmet-mode
#+begin_src emacs-lisp :tangle yes
  (use-package emmet-mode
    :ensure t
    :hook ((jtsx-tsx-mode jtsx-jsx-mode astro-ts-mode) . emmet-mode)
    :config
    (add-to-list 'emmet-jsx-major-modes 'jtsx-tsx-mode))
#+end_src
** macrostep use-packageなどのマクロを展開してデバッグする
#+begin_src emacs-lisp :tangle yes
  (use-package macrostep
    :ensure t

    :commands (macrostep-expand macrostep-mode))
#+end_src
* 補完インターフェイス minadさんシリーズ
** [[https://github.com/oantolin/orderless][orderless]] 順不同のテキストマッチングスタイル
#+begin_src emacs-lisp :tangle yes
  (leaf orderless
    :ensure t
    :config
    (setopt completion-styles '(orderless basic))
    (setopt completion-category-defaults nil)
    (setopt completion-category-overrides '((file (styles partial-completion)))))
#+end_src
** [[https://github.com/minad/marginalia][marginalia]] 補完候補により多くの情報を表示する
#+begin_src emacs-lisp :tangle yes
  (leaf marginalia
    :doc "Enrich existing commands with completion annotations"
    :url "https://github.com/minad/marginalia"
    :ensure t
    :global-minor-mode t
    :config
    (leaf nerd-icons-completion
      :doc "Add icons to completion candidates"
      :url "https://github.com/rainstormstudio/nerd-icons-completion"
      :ensure t
      :global-minor-mode t
      :hook (marginalia-mode-hook . nerd-icons-completion-marginalia-setup)))
#+end_src
** [[https://github.com/oantolin/embark][embark]] ミニバッファ補完の選択肢に対して右クリック的な操作を行える
#+begin_src emacs-lisp :tangle yes
  (leaf embark
    :ensure t
    :bind (("C-." . embark-act)         ;; pick some comfortable binding
           ("C-;" . embark-dwim)        ;; good alternative: M-.
           ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'
    :init
    (setq prefix-help-command #'embark-prefix-help-command)
    ;; (add-hook 'eldoc-documentation-functions #'embark-eldoc-first-target)
    (setq eldoc-documentation-strategy #'eldoc-documentation-compose-eagerly))
#+end_src
** grepの結果を編集する [[https://github.com/mhayashi1120/Emacs-wgrep][wgrep]]
#+begin_src emacs-lisp :tangle yes
  (leaf wgrep
    :ensure t)
#+end_src
** [[https://github.com/minad/vertico][vertico]] ミニバッファ補完インターフェイス
#+begin_src emacs-lisp :tangle yes
  (leaf vertico
    :ensure t
    :require t
    :bind (("s-SPC" . my/vertico-restrict-to-matches))
    :config
    (setopt vertico-count 30)
    (vertico-mode)

    (defun my/vertico-restrict-to-matches ()
      "現在マッチしている候補のみに選択肢を絞った状態でプロンプトをクリアする。

  実際にはクリアしているわけではない。
  https://github.com/minad/vertico/wiki#restrict-the-set-of-candidates"
      (interactive)
      (let ((inhibit-read-only t))
        (goto-char (point-max))
        (insert " ")
        (add-text-properties (minibuffer-prompt-end) (point-max)
                             '(invisible t read-only t cursor-intangible t rear-nonsticky t))))

    ;; 選択行に猫を表示する
    ;; https://github.com/minad/vertico/wiki#prefix-current-candidate-with-arrow
    (defvar +vertico-current-arrow t)
    (cl-defmethod vertico--format-candidate :around
      (cand prefix suffix index start &context ((and +vertico-current-arrow
                                                     (not (bound-and-true-p vertico-flat-mode)))
                                                (eql t)))
      (setq cand (cl-call-next-method cand prefix suffix index start))
      (let ((cat (nerd-icons-faicon "nf-fa-cat"))
            (blank (nerd-icons-codicon "nf-cod-blank")))
        (if (bound-and-true-p vertico-grid-mode)
            (if (= vertico--index index)
                (concat cat " " cand)
              (concat blank " " cand))
          (if (= vertico--index index)
              (concat cat " " cand)
            (concat blank " " cand))))))

  (leaf cus-start
    :config
      ;;; minibuf.c
    ;; [vertico]ミニバッファ内で新たにミニバッファを開けるようにする
    (setq enable-recursive-minibuffers t)
    ;; [vertico]正直よくわからない。後日検証。readmeのおすすめ設定に載っているのでとりあえず書いておく。
    (setq minibuffer-prompt-properties '(read-only t cursor-intangible t face minibuffer-prompt))
    ;; [vertico]ignore-caseにバッファをミニバッファ補完
    (setq read-buffer-completion-ignore-case t)
    ;; [vertico]ignore-caseにコマンドをミニバッファ補完
    (setq completion-ignore-case t))

  (leaf simple
    :config
    ;; [vertico]M-xで表示される候補を現在のモードで実行可能なコマンドだけに限定する
    (setopt read-extended-command-predicate #'command-completion-default-include-p))
#+end_src

=vertico-multiform= 補完候補の表示方法をインタラクティブに変更できる
| =M-B= | ~vertico-multiform-buffer~      |
| =M-F= | ~vertico-multiform-flat~        |
| =M-G= | ~vertico-multiform-grid~        |
| =M-R= | ~vertico-multiform-reverse~     |
| =M-U= | ~vertico-multiform-unobtrusive~ |
| =M-V= | ~vertico-multiform-vertical~    |
#+begin_src emacs-lisp :tangle yes
(leaf vertico-multiform
    :require t
    :config
    (vertico-multiform-mode))
#+end_src

=vertico-buffer= mini bufferではなくbufferで補完を開く
#+begin_src emacs-lisp :tangle yes
(leaf vertico-buffer
    :require t
    :config
    (setopt vertico-buffer-display-action (lambda () (display-buffer-in-direction
                                                      (direction . right)))))
#+end_src

=vertico-directory= C-fが扱いやすくなる
#+begin_src emacs-lisp :tangle yes
(leaf vertico-directory
    :require t
    :bind (vertico-map
           ("RET" . vertico-directory-enter)
           ("DEL" . vertico-directory-delete-char)
           ("M-DEL" . vertico-directory-delete-word))
    :hook ((rfn-eshadow-update-overlay-hook . vertico-directory-tidy)))
#+end_src

*** ミニバッファの履歴を永続化する
#+begin_src emacs-lisp :tangle yes
  (leaf savehist
    :config
    (savehist-mode 1))
#+end_src

*** その他ミニバッファ関連
#+begin_src emacs-lisp :tangle yes
  (leaf minibuffer
    :config
    ;; ミニバッファ補完時にファイル名をignore-caseにマッチさせる
    (setopt read-file-name-completion-ignore-case t))
#+end_src
** [[https://github.com/minad/corfu][corfu]] コード補完
#+begin_src emacs-lisp :tangle yes
  ;; (leaf hotfuzz
  ;;   :ensure t)

  ;; (use-package fzf-native
  ;;   :ensure
  ;;   :config
  ;;   (fzf-native-load-dyn)
  ;;   (setq fussy-score-fn 'fussy-fzf-native-score))

  ;; (use-package fussy
  ;;   :ensure
  ;;   :config
  ;;   (setq fussy-score-ALL-fn 'fussy-fzf-score)
  ;;   (setq fussy-filter-fn 'fussy-filter-default)
  ;;   (setq fussy-use-cache t)
  ;;   (setq fussy-compare-same-score-fn 'fussy-histlen->strlen<)
  ;;   (fussy-setup)
  ;;   (advice-add 'corfu--capf-wrapper :before 'fussy-wipe-cache))

  ;; (leaf corfu
  ;;   :doc "コード補完機能"
  ;;   :ensure t
  ;;   :require t
  ;;   :bind ((corfu-map
  ;;           ("M-SPC" . corfu-insert-separator)))
  ;;   ;; :hook ((corfu-mode-hook
  ;;   ;;         . (lambda ()
  ;;   ;;             (setq-local fussy-max-candidate-limit 5000
  ;;   ;;                         fussy-default-regex-fn 'fussy-pattern-first-letter
  ;;   ;;                         fussy-prefer-prefix nil))))

  ;;   :config
  ;;   (setopt corfu-auto t)
  ;;   (setopt corfu-auto-delay 0.0)
  ;;   (setopt corfu-auto-prefix 1)
  ;;   (setopt corfu-popupinfo-delay 0.0)

  ;;   (setopt tab-always-indent 'complete)
  ;;   (setopt text-mode-ispell-word-completion nil)
  ;;   (setopt read-extended-command-predicate #'command-completion-default-include-p)

  ;;   (global-corfu-mode)
  ;;   (corfu-popupinfo-mode)
  ;;   (corfu-history-mode))



  (use-package hotfuzz
    :ensure t

    :hook ((corfu-mode . (lambda () (setq-local completion-styles '(hotfuzz))))))

  (use-package corfu
    :ensure t

    :custom
    (corfu-auto t)
    (corfu-auto-delay 0.0)
    (corfu-auto-prefix 1)
    (corfu-popupinfo-delay 0.0)

    :init
    (global-corfu-mode)
    (corfu-history-mode)
    (corfu-popupinfo-mode))

  (use-package emacs
    :custom
    (tab-always-indent 'complete)
    (text-mode-ispell-word-completion nil)
    (read-extended-command-predicate #'command-completion-default-include-p))
#+end_src
*** corfuの補完候補にアイコンを表示する [[https://github.com/LuigiPiucco/nerd-icons-corfu][nerd-icons-corfu]]
#+begin_src emacs-lisp :tangle yes
  (leaf nerd-icons-corfu
    :ensure t
    :config
    (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))
#+end_src
** 便利な補完機能をたくさん提供してくれる [[https://github.com/minad/consult][consult]]
#+begin_src emacs-lisp :tangle yes
  (leaf consult
    :doc "Consulting completing-read"
    :url "https://github.com/minad/consult"
    :ensure t
    :defun (consult-customize consult--read)
    :bind* (;; C-c bindings in `mode-specific-map'
            ("C-c M-x" . consult-mode-command)
            ;; C-x bindings in `ctl-x-map'
            ("C-x b" . consult-buffer)
            ("C-x M-p" . consult-project-buffer)
            ("C-x C-g" . my/consult-ghq-magit-status)
            ;; Other custom bindings
            ("M-y" . consult-yank-pop)
            ;; M-g bindings in `goto-map'
            ("M-g f" . consult-flymake)
            ("M-g g" . consult-goto-line)
            ("M-g m" . consult-mark)
            ("M-g k" . consult-global-mark)
            ("M-g i" . consult-imenu)
            ("M-g I" . consult-imenu-multi)
            ("M-g o" . consult-outline)
            ;; M-s bindings in `search-map'
            ("M-s d" . consult-fd)
            ("M-s g d" . my-consult-ghq-fd)
            ("M-s c" . consult-locate)
            ("M-s r" . consult-ripgrep)
            ("M-s g r" . my-consult-ghq-ripgrep)
            ("M-s l" . my/consult-line)
            ("M-s L" . consult-line-multi))
    :hook (completion-list-mode-hook . consult-preview-at-point-mode)
    :config
    (setopt xref-show-xrefs-function #'consult-xref)
    (setopt xref-show-definitions-function #'consult-xref)

    (defun my/consult-line (flag)
      "prefix付きで呼び出された場合、カーソル位置のシンボルをデフォルトの検索文字列とする"
      (interactive "P")
      (if flag
          (consult-line (thing-at-point 'symbol))
        (consult-line)))

    (leaf *consult-ghq
      :defun (buffer-substring-no-propertie my-consult-ghq--list-candidates my-consult-ghq--read consult--file-preview)
      :config
      (defun my-consult-ghq--list-candidates ()
        "ghq listの結果をリストで返す"
        (with-temp-buffer
          (unless (zerop (apply #'call-process "ghq" nil t nil '("list" "--full-path")))
            (error "Failed: Cannot get ghq list candidates"))
          (let ((paths))
            (goto-char (point-min))
            (while (not (eobp))
              (push (buffer-substring-no-properties
                     (line-beginning-position)
                     (line-end-position))
                    paths)
              (forward-line 1))
            (nreverse paths))))
      (defun my-consult-ghq--read ()
        "ghq管理のリポジトリ一覧から選ぶ"
        (consult--read (my-consult-ghq--list-candidates)
                       :state (consult--file-preview)
                       :prompt "ghq: "
                       :category 'file))
      (defun my-consult-ghq-fd ()
        "ghq管理のリポジトリ一覧から選び、プロジェクト内ファイル検索"
        (interactive)
        (consult-fd (my-consult-ghq--read)))
      (defun my-consult-ghq-ripgrep ()
        "ghq管理のリポジトリ一覧から選び、プロジェクト内でripgrep"
        (interactive)
        (consult-ripgrep (my-consult-ghq--read)))
      (defun my/consult-ghq-magit-status ()
        "ghq管理のリポジトリ一覧から選び、magit statusを開く"
        (interactive)
        (magit-status (my-consult-ghq--read))))

    (defun my-consult-switch-buffer-kill ()
      "Kill candidate buffer at point within the minibuffer completion."
      (interactive)
      ;; The vertico--candidate has a irregular char at the end.
      (let ((name  (substring (vertico--candidate) 0 -1)))
        (when (bufferp (get-buffer name))
          (kill-buffer name))))
    )
#+end_src
*** embarkインテグレーション [[https://github.com/oantolin/embark/tree/master?tab=readme-ov-file#consult][embark-consult]]
#+begin_src emacs-lisp :tangle yes
  (leaf embark-consult
    :ensure t
    :require t
    :hook (embark-collect-mode-hook . consult-preview-at-point-mode))
#+end_src
*** yasnippet連携 [[https://github.com/mohkale/consult-yasnippet][consult-yasnippet]]
#+begin_src emacs-lisp :tangle yes
  (leaf consult-yasnippet
    :ensure t
    :bind (("C-x M-s" . consult-yasnippet)))
#+end_src
* git
** [[https://magit.vc/][magit]] gitクライアント
#+begin_src emacs-lisp :tangle yes
  (leaf magit
    :ensure t)
#+end_src
*** [[https://magit.vc/manual/forge.html][forge]] magitからgithubを操作する
#+begin_src emacs-lisp :tangle yes
  (leaf forge
    :ensure t
    :config
    (setopt forge-buffer-draft-p t))
#+end_src
** [[https://github.com/dgutov/diff-hl][diff-hl]] 行頭にgitのステータスを表示する
#+begin_src emacs-lisp :tangle yes
  (leaf diff-hl
    :ensure t
    :require t
    :hook ((magit-post-refresh-hook . diff-hl-magit-post-refresh)
           (dired-mode-hook . diff-hl-dired-mode))
    :config
    (global-diff-hl-mode)
    (global-diff-hl-show-hunk-mouse-mode))
#+end_src
** [[https://github.com/sshaw/git-link][git-link]] 現在開いているブランチ/ファイル/行のgithubのを作る
#+begin_src emacs-lisp :tangle yes
  (leaf git-link
    :ensure t)
#+end_src
** [[https://github.com/redguardtoo/vc-msg][vc-msg]] 現在行の直近のコミットを表示する
#+begin_src emacs-lisp :tangle yes
  (leaf vc-msg
    :ensure t)
#+end_src
** diffを見やすくする [[https://github.com/pkryger/difftastic.el][difftastic]]
#+begin_src emacs-lisp :tangle yes
  (leaf difftastic
    :ensure t
    :config
    (difftastic-bindings-mode))
#+end_src
** diffを見やすくする [[https://github.com/dandavison/magit-delta][magit-delta]]
#+begin_src emacs-lisp :tangle yes
  (leaf magit-delta
    :ensure t
    :hook ((magit-mode-hook . magit-delta-mode))
    :config
    (setopt  magit-delta-default-dark-theme "Solarized (dark)"))
#+end_src
* マイナーモード
** [[https://github.com/radian-software/apheleia][apheleia]] いろんな言語のフォーマッターインテグレーション
#+begin_src emacs-lisp :tangle yes
  (leaf apheleia
    :ensure t
    :hook ((jtsx-tsx-mode-hook jtsx-jsx-mode-hook jtsx-typescript-mode-hook nix-ts-mode-hook astro-ts-mode-hook json-ts-mode terraform-mode-hook) . apheleia-mode)
    :commands (apheleia-mode apheleia-format-buffer)
    :config
    (setopt apheleia-formatters-respect-indent-level nil)
    (add-to-list 'apheleia-formatters '(prettier-astro . ("apheleia-npx" "prettier" "--stdin-filepath" filepath
                                                          "--plugin=prettier-plugin-astro" "--parser=astro")))
    (add-to-list 'apheleia-formatters '(biome . ("apheleia-npx" "biome" "check" "--write" "--stdin-file-path" filepath)))
    (add-to-list 'apheleia-mode-alist '(astro-ts-mode . prettier-astro))
    (add-to-list 'apheleia-mode-alist '(scss-ts-mode . prettier-scss)))
#+end_src
** [[https://github.com/casouri/expreg][expreg]]
現在のポイントを中心にリージョン(選択範囲)を広げていく。
個人的Emacsのキラープラグインの一つ。コピペエンジニアとしてはこれがないとまともに編集できない。
#+begin_src emacs-lisp :tangle yes
  (leaf expreg
    :ensure t
    :bind (("C-z" . expreg-expand)
           ("C-M-z" . expreg-contract)))
#+end_src
** htmlタグを扱う [[https://github.com/magnars/tagedit][tagedit]]
#+begin_src emacs-lisp :tangle yes
  (leaf tagedit
    :ensure t
    :bind ((("C-c k" . tagedit-kill))))
#+end_src
** treesit シンタックスハイライト
#+begin_src emacs-lisp :tangle yes
  (use-package treesit
    :custom
    (treesit-font-lock-level 4))
#+end_src
* LSP
** 標準LSPクライアント [[https://github.com/joaotavora/eglot][eglot]]
#+begin_src emacs-lisp :tangle no
  (leaf eglot
    :hook (((nix-ts-mode-hook) . eglot-ensure))
    :bind (:eglot-mode-map
           ("C-c l r r" . my/eglot-rename)
           ("C-c l a" . eglot-code-actions))
    :config
    (add-to-list 'eglot-server-programs '(nix-ts-mode . ("nil")))

    (leaf eglot-booster
      :ensure t
      :config
      (setopt eglot-booster-io-only t)
      (eglot-booster-mode))

    (leaf consult-eglot
      :ensure t
      :bind (:eglot-mode-map
             ("M-g e" . consult-eglot-symbols)))

    (leaf eglot-signature-eldoc-talkative
      :ensure t
      :require t
      :config
      (advice-add #'eglot-signature-eldoc-function
                  :override #'eglot-signature-eldoc-talkative))

    (defun my/eglot-rename ()
      "eglot-renameの改良版"
      (interactive)
      (if-let* ((symbol (thing-at-point 'symbol t))
                (newname (string-trim
                          (read-from-minibuffer (format "Rename `%s' to: " symbol) symbol))))
          (cond ((string-empty-p newname)
                 (user-error "空の名前は受け付けません"))
                ((string-search " " newname)
                 (user-error "ホワイトスペースを含む変数名はダメでしょ"))
                ((string= symbol newname)
                 (user-error "元の名前と同じやん"))
                (t
                 (eglot-rename newname)))
        (user-error "ポイントにシンボルがないです"))))
#+end_src
** Rust製 LSPクランアント [[https://github.com/jadestrong/lsp-proxy][lsp-proxy]]
#+begin_src emacs-lisp :tangle no
  (leaf lsp-proxy
    :ensure t
    :require t
    :bind (:lsp-proxy-mode-map
           ("C-c l r r" . lsp-proxy-rename)
           ("C-c l a" . lsp-proxy-execute-code-action)
           ("C-c d" . my/lsp-proxy-help-tap))
    :hook (((jtsx-tsx-mode-hook jtsx-jsx-mode-hook jtsx-typescript-mode-hook astro-ts-mode-hook) . lsp-proxy-mode))
    :config
    (setopt lsp-proxy-user-languages-config (no-littering-expand-etc-file-name "languages.toml"))
    (setopt lsp-proxy-diagnostics-provider :flymake)
    (setopt lsp-proxy-log-file-directory (no-littering-expand-var-file-name "lsp-proxy-logs/"))
    (setopt lsp-proxy-log-max 0) ; 100000
    (setopt lsp-proxy-log-buffer-max nil)
    (setopt lsp-proxy-log-level 0) ; 3


    (defconst my/lsp-proxy-help-tap--buffer "*my-lsp-proxy-help*")
    (defvar my/lsp-proxy-help-tap--last-point nil)

    (defun my/lsp-proxy-help-tap--delete-frame ()
      "表示中のposframeを削除する"
      (posframe-delete my/lsp-proxy-help-tap--buffer)
      (advice-remove 'my/keyboard-quit-dwim #'my/lsp-proxy-help-tap--delete-frame))

    (defun my/lsp-proxy-help-tap--hidehandler (_info)
      "カーソルを移動したらframeを消す"
      (let ((should-close (not (equal my/lsp-proxy-help-tap--last-point
                                      (point)))))
        (when should-close
          (my/lsp-proxy-help-tap--delete-frame))
        should-close))

    (defun my/lsp-proxy-help-tap ()
      "lspのtextDocument/hover情報をposframeに表示する"
      (interactive)
      (if-let* ((help-text (lsp-proxy--request 'textDocument/hover
                                               (lsp-proxy--request-or-notify-params
                                                (eglot--TextDocumentPositionParams))))
                (formated-help-text (eglot--format-markup help-text)))
          (progn
            (posframe-show my/lsp-proxy-help-tap--buffer
                           :string formated-help-text
                           :position (point)
                           :max-width 80
                           :max-height 160
                           :border-width 4
                           :background-color "#001e27"
                           :hidehandler #'my/lsp-proxy-help-tap--hidehandler)

            (setq my/lsp-proxy-help-tap--last-point (point))
            (advice-add 'my/keyboard-quit-dwim
                        :before
                        #'my/lsp-proxy-help-tap--delete-frame)))))
#+end_src
** 結局はこれ [[https://github.com/casouri/eldoc-box][lsp-mode]]
#+begin_src emacs-lisp :tangle yes
  (leaf cape
    :ensure t)

  (leaf lsp-mode
    :ensure t
    :hook (((typescript-ts-mode-hook tsx-ts-mode-hook astro-ts-mode-hook nix-ts-mode-hook html-ts-mode-hook css-ts-mode-hook toml-ts-mode-hook json-ts-mode-hook terraform-mode-hook) . lsp-deferred)
           (lsp-mode-hook . lsp-enable-which-key-integration)
           (lsp-completion-mode-hook . my/lsp-mode-setup-completion))
    :init
    (defun my/lsp-mode-setup-completion ()
      (setf (alist-get 'styles (alist-get 'lsp-capf completion-category-defaults))
            '(hotfuzz)))

    :config
    ;; 使わない機能をオフにする
    (setopt lsp-headerline-breadcrumb-enable nil)
    (setopt lsp-modeline-diagnostics-enable nil)
    (setopt lsp-modeline-workspace-status-enable nil)
    (setopt lsp-modeline-code-actions-enable nil)
    (setopt lsp-semantic-tokens-enable nil)
    (setopt lsp-enable-folding nil)
    (setopt lsp-progress-via-spinner nil) ; モードラインにスピナーを表示する
    (setopt lsp-enable-dap-auto-configure nil) ; dap-modeを自動で設定する
    (setopt lsp-enable-indentation nil)
    (setopt lsp-enable-on-type-formatting nil) ; キーワード（`}'など）を入力時に自動フォーマットする
    (setopt lsp-enable-text-document-color nil) ; カラーコードに色をつける
    (setopt lsp-progress-function 'ignore)      ; modelineにプログレスを表示する

    ;; フォーマットはaphalia&linterで賄うからイラン
    (setopt lsp-trim-trailing-whitespace nil)   ; 行末のホワイトスペース削除
    (setopt lsp-insert-final-newline nil)       ; ファイル末尾に一つだけ改行
    (setopt lsp-trim-final-newlines nil)        ; ファイル末尾に一つだけ改行

    ;; 勝手にlsp serverからの変更提案を反映しない
    (setopt lsp-before-save-edits nil)
    (setopt lsp-apply-edits-after-file-operations nil)

    ;; ファイルを監視しない
    (setopt lsp-enable-file-watchers nil)


    (setopt lsp-completion-provider :none)
    ;; (setopt lsp-diagnostics-provider :flymake)

    (setopt lsp-auto-execute-action nil)  ; 可能なアクションが１つの場合、確認無しに実行する
    (setopt lsp-eldoc-render-all t)       ; サーバーから返ってきたドキュメントを全て表示する

    ;; typescript
    (setopt lsp-typescript-format-enable nil)
    (setopt lsp-typescript-references-code-lens-enabled t)
    (setopt lsp-typescript-implementations-code-lens-enabled t)
    (setopt lsp-javascript-format-enable nil)
    (setopt lsp-javascript-display-return-type-hints t)
    (setopt lsp-javascript-display-parameter-type-hints t)
    (setopt lsp-javascript-display-parameter-name-hints-when-argument-matches-name t)
    (setopt lsp-javascript-display-property-declaration-type-hints t)
    (setopt lsp-javascript-display-variable-type-hints t)

    ;; eslint
    (setopt lsp-eslint-server-command '("vscode-eslint-language-server" "--stdio"))

    (setopt lsp-html-format-enable nil)
    (setopt lsp-yaml-format-enable nil)

    (add-to-list 'lsp-language-id-configuration '(scss-ts-mode . "scss"))

    (leaf lsp-tailwindcss
      :ensure t
      :init
      (setq lsp-tailwindcss-add-on-mode t)
      :config
      (setq lsp-tailwindcss-major-modes '(tsx-ts-mode astro-ts-mode))
      ;; (setopt lsp-tailwindcss-skip-config-check t)
      (setopt lsp-tailwindcss-server-path (string-trim (shell-command-to-string "which tailwindcss-language-server"))))

    (use-package lsp-biome
      :ensure t
      :preface
      (defun my/lsp-biome-active-hook ()
        (setq-local apheleia-formatter '(biome)))

      :config
      (add-hook 'lsp-biome-active-hook #'my/lsp-biome-active-hook))

    (defun lsp-booster--advice-json-parse (old-fn &rest args)
      "Try to parse bytecode instead of json."
      (or
       (when (equal (following-char) ?#)
         (let ((bytecode (read (current-buffer))))
           (when (byte-code-function-p bytecode)
             (funcall bytecode))))
       (apply old-fn args)))
    (advice-add (if (progn (require 'json)
                           (fboundp 'json-parse-buffer))
                    'json-parse-buffer
                  'json-read)
                :around
                #'lsp-booster--advice-json-parse)

    (defun lsp-booster--advice-final-command (old-fn cmd &optional test?)
      "Prepend emacs-lsp-booster command to lsp CMD."
      (let ((orig-result (funcall old-fn cmd test?)))
        (if (and (not test?)                             ;; for check lsp-server-present?
                 (not (file-remote-p default-directory)) ;; see lsp-resolve-final-command, it would add extra shell wrapper
                 lsp-use-plists
                 (not (functionp 'json-rpc-connection))  ;; native json-rpc
                 (executable-find "emacs-lsp-booster"))
            (progn
              (when-let ((command-from-exec-path (executable-find (car orig-result))))  ;; resolve command from exec-path (in case not found in $PATH)
                (setcar orig-result command-from-exec-path))
              (message "Using emacs-lsp-booster for %s!" orig-result)
              (cons "emacs-lsp-booster" orig-result))
          orig-result)))
    (advice-add 'lsp-resolve-final-command :around #'lsp-booster--advice-final-command)
    )
#+end_src
* 言語
** [[https://github.com/Malabarba/aggressive-indent-mode][aggressive-indent]] Emacs Lisp
#+begin_src emacs-lisp :tangle yes
  (use-package aggressive-indent
    :ensure t

    :hook ((emacs-lisp-mode . aggressive-indent-mode))

    :config
    (add-to-list 'aggressive-indent-excluded-modes 'lisp-interaction-mode))
#+end_src
** JavaSctipt
#+begin_src emacs-lisp :tangle yes
  (use-package js-ts-mode
    :custom
    (js-indent-level 2)

    :mode ("\\.js\\'" "\\.cjs\\'" "\\.mjs\\'"))
#+end_src
** TypeScript
#+begin_src emacs-lisp :tangle yes
  (use-package typescript-ts-mode
    :mode ("\\.ts\\'" "\\.mts\\'" "\\.cts\\'"))
#+end_src
** [[https://github.com/llemaitre19/jtsx][jtsx]] JSX / TSX
#+begin_src emacs-lisp :tangle yes
  (use-package jtsx
    :ensure t

    :mode (("\\.jsx\\'" . jtsx-jsx-mode)
           ("\\.tsx\\'" . jtsx-tsx-mode))

    :custom
    (js-indent-level 2)

    :config
    (defun jtsx-bind-keys-to-mode-map (mode-map)
      "Bind keys to MODE-MAP."
      (define-key mode-map (kbd "C-c C-j") 'jtsx-jump-jsx-element-tag-dwim)
      (define-key mode-map (kbd "C-c j o") 'jtsx-jump-jsx-opening-tag)
      (define-key mode-map (kbd "C-c j c") 'jtsx-jump-jsx-closing-tag)
      (define-key mode-map (kbd "C-c j r") 'jtsx-rename-jsx-element)
      (define-key mode-map (kbd "C-c <down>") 'jtsx-move-jsx-element-tag-forward)
      (define-key mode-map (kbd "C-c <up>") 'jtsx-move-jsx-element-tag-backward)
      (define-key mode-map (kbd "C-c C-<down>") 'jtsx-move-jsx-element-forward)
      (define-key mode-map (kbd "C-c C-<up>") 'jtsx-move-jsx-element-backward)
      (define-key mode-map (kbd "C-c C-S-<down>") 'jtsx-move-jsx-element-step-in-forward)
      (define-key mode-map (kbd "C-c C-S-<up>") 'jtsx-move-jsx-element-step-in-backward)
      (define-key mode-map (kbd "C-c j w") 'jtsx-wrap-in-jsx-element)
      (define-key mode-map (kbd "C-c j u") 'jtsx-unwrap-jsx)
      (define-key mode-map (kbd "C-c j d n") 'jtsx-delete-jsx-node)
      (define-key mode-map (kbd "C-c j d a") 'jtsx-delete-jsx-attribute)
      (define-key mode-map (kbd "C-c j t") 'jtsx-toggle-jsx-attributes-orientation)
      (define-key mode-map (kbd "C-c j h") 'jtsx-rearrange-jsx-attributes-horizontally)
      (define-key mode-map (kbd "C-c j v") 'jtsx-rearrange-jsx-attributes-vertically))

    (defun jtsx-bind-keys-to-jtsx-jsx-mode-map ()
      (jtsx-bind-keys-to-mode-map jtsx-jsx-mode-map))

    (defun jtsx-bind-keys-to-jtsx-tsx-mode-map ()
      (jtsx-bind-keys-to-mode-map jtsx-tsx-mode-map))

    (add-hook 'jtsx-jsx-mode-hook 'jtsx-bind-keys-to-jtsx-jsx-mode-map)
    (add-hook 'jtsx-tsx-mode-hook 'jtsx-bind-keys-to-jtsx-tsx-mode-map))
#+end_src
** [[https://github.com/Sorixelle/astro-ts-mode][astro-ts-mode]] Astro
#+begin_src emacs-lisp :tangle yes
  (use-package astro-ts-mode
    :ensure t

    :mode "\\.astro\\'")
#+end_src

astroのgrammarがなければインストール。本当はnixで入れたいけどやり方がよく分からん。
#+begin_src emacs-lisp :tangle yes
  (unless (treesit-language-available-p 'astro nil)
    (let ((treesit-language-source-alist  '((astro "https://github.com/virchau13/tree-sitter-astro"))))
      (treesit-install-language-grammar 'astro)))
#+end_src
** HTML
#+begin_src emacs-lisp :tangle yes
  (use-package html-ts-mode
    :mode ("\\.html\\'"))
#+end_src
** CSS
#+begin_src emacs-lisp :tangle yes
  ;; 編集機能としてはscssもcss-ts-modeで十分なのだが、
  ;; apheleiaでPrettierをかける時にcssパーサーを使用することになり
  ;; scssだとフォーマットできないため、別名のモードを作って
  ;; フォーマットオプションを分岐させる。
  (define-derived-mode scss-ts-mode css-ts-mode "SCSS")

  (use-package css-mode
    :mode (("\\.css\\'" . css-ts-mode)
           ("\\.scss\\'" . scss-ts-mode))

    :custom
    (css-indent-offset 2))
#+end_src
** [[https://github.com/nix-community/nix-ts-mode][nix-ts-mode]] nix-ts-mode
#+begin_src emacs-lisp :tangle yes
  (use-package nix-ts-mode
    :ensure t

    :mode "\\.nix\\'")
#+end_src
** [[https://github.com/hcl-emacs/terraform-mode][terraform-mode]] Terraform
#+begin_src emacs-lisp :tangle yes
  (use-package terraform-mode
    :ensure t

    :config
    (add-hook 'terraform-mode-hook #'outline-minor-mode))
#+end_src
** JSON
#+begin_src emacs-lisp :tangle yes
  (use-package json-ts-mode
    :mode ("\\.jsonc?\\'"))
#+end_src
** Python
python.el内でadd-to-listされているので設定いらなさそう。未検証。
#+begin_src emacs-lisp :tangle no
  (use-package python
    :mode ("\\.py[iw]?\\'" . python-ts-mode)
    :interpreter "python[0-9.]*")
#+end_src
** YAML
yaml-ts-mode.el内でadd-to-listされているので設定いらなさそう。未検証。
#+begin_src emacs-lisp :tangle no
  (use-package yaml-ts-mode
    :mode ("\\.ya?ml\\'"))
#+end_src
** TOML
toml-ts-mode.elでadd-to-listされているので設定いらなさそう。未検証。
#+begin_src emacs-lisp :tangle no
  (use-package toml-ts-mode
    :mode ("\\.toml\\'"))
#+end_src
** Dockerfile
dockerfile-ts-mode.elでadd-to-listされているので設定いらなさそう。未検証。
#+begin_src emacs-lisp :tangle no
  (use-package dockerfile-ts-mode
    :mode ("\\(?:Dockerfile\\(?:\\..*\\)?\\|\\.[Dd]ockerfile\\)\\'"))
#+end_src
* org-mode
#+begin_src emacs-lisp :tangle yes
  (leaf org
    :doc "Outline-based notes management and organizer"
    :require t
    :bind (org-mode-map
           ;; superを小文字のsでバインドし直さないと呼び出せない。そういうもんだっけ？
           ("M-s-RET" . org-insert-todo-heading)
           ("M-s-<return>" . org-insert-todo-heading)
           ("C-s-RET" . org-insert-todo-heading-respect-content)
           ("C-s-<return>" . org-insert-todo-heading-respect-content)
           ("M-s-<left>" . org-promote-subtree)
           ("M-s-<right>" . org-demote-subtree))
    :hook ((org-mode-hook . my/setup-org-mode))
    :config
    (setopt org-directory "~/ghq/github.com/yasushiasahi/org")
    (setopt org-M-RET-may-split-line nil)
    (setopt org-use-speed-commands t)
    (setopt org-startup-indented t)

    (defun my/setup-org-mode ()
      "保存前に行末のスペースを削除"
      (add-hook 'before-save-hook 'delete-trailing-whitespace nil 'make-it-local)))
#+end_src
** org-capture
#+begin_src emacs-lisp :tangle no
  (leaf org-capture
    :doc "Fast note taking in Org"
    :tag "builtin" "text" "calendar" "hypermedia" "outlines"
    :url "https://orgmode.org"
    :bind (("C-c c" . org-capture))
    :config
    (setopt org-capture-templates `(("n" "Memo" entry
                                     (file+headline ,(expand-file-name "memo.org" org-directory) "Memos")
                                     "* %?\nEntered on %U\n %i\n %a"))))
#+end_src
** 第二の脳 [[https://github.com/org-roam/org-roam][org-roam]]
- complation-at-pointでlinkを挿入できるらしいけどうまくいかない
#+begin_src emacs-lisp :tangle yes
  (leaf org-roam
    :ensure t
    :bind (("C-c n l" . org-roam-buffer-toggle)
           ("C-c n f" . org-roam-node-find)
           ("C-c n i" . org-roam-node-insert)
           (:org-mode-map
            ("C-M-i" . completion-at-point)))
    :config
    (setopt org-roam-directory "~/ghq/github.com/yasushiasahi/org/roam")
    (setopt org-roam-complete-everywhere t)

    (org-roam-setup))
#+end_src
** かっこいい見た目にする [[https://github.com/minad/org-modern/tree/main][org-modern]]
#+begin_src emacs-lisp :tangle yes
  (leaf org-modern
    :ensure t
    :hook ((org-mode-hook . org-modern-mode)
           (org-agenda-finalize-hook . org-modern-agenda))
    :config
    (setopt org-modern-star 'replace)

    (setopt org-auto-align-tags nil)
    (setopt org-tags-column 0)
    (setopt org-catch-invisible-edits 'show-and-error)
    (setopt org-special-ctrl-a/e t)
    (setopt org-insert-heading-respect-content t)

    (setopt org-hide-emphasis-markers t)
    (setopt org-pretty-entities t)
    (setopt org-agenda-tags-column 0))
#+end_src
*** org-modernをindentに対応させる [[https://github.com/jdtsmith/org-modern-indent][org-modern-indent]]
#+begin_src emacs-lisp :tangle yes
  (leaf org-modern-indent
    :ensure t
    :hook ((org-modern-mode-hook . org-modern-indent-mode))
    :config
    (set-face-attribute 'org-modern-symbol nil :family "Iosevka")
    (set-face-attribute 'org-modern-indent-bracket-line nil :family "Iosevka")
    (set-face-attribute 'org-modern-block-name nil :family "Iosevka")
    (set-face-attribute 'org-block-begin-line nil :underline nil :family "Iosevka")
    (set-face-attribute 'org-block-end-line nil :overline nil :family "Iosevka")
    (set-face-attribute 'org-block nil :background "#001e27"))
#+end_src
** org-src
#+begin_src emacs-lisp :tangle yes
  (leaf org-src
    :require t
    :config
    (setopt org-src-window-setup 'current-window)
    (setopt org-src-tab-acts-natively nil))
#+end_src
*** ob-typescript
#+begin_src emacs-lisp :tangle yes
  (leaf ob-typescript
    :doc "Org-babel functions for typescript evaluation"
    :url "https://github.com/lurdan/ob-typescript"
    :ensure t)
  (org-babel-do-load-languages 'org-babel-load-languages '((typescript . t)))
  (add-to-list 'org-src-lang-modes '("typescript" . jtsx-typescript))


  (leaf ob-shell
    :doc "Babel Functions for Shell Evaluation"
    :tag "builtin" "reproducible research" "literate programming"
    :url "https://orgmode.org"
    :added "2025-05-29")

  (org-babel-do-load-languages 'org-babel-load-languages '((shell . t)))
  (add-to-list 'org-src-lang-modes '("shell" . bash-ts))

  (org-babel-do-load-languages 'org-babel-load-languages '((css . t)))
  (add-to-list 'org-src-lang-modes '("css" . css-ts))

  (org-babel-do-load-languages 'org-babel-load-languages '((js . t)))
  (add-to-list 'org-src-lang-modes '("js" . jtsx-jsx))

  (add-to-list 'org-src-lang-modes '("markdown" . markdown))
  (add-to-list 'org-src-lang-modes '("html" . html-ts))
  (add-to-list 'org-src-lang-modes '("astro" . astro-ts))
#+end_src

#+begin_src html
  <div></div>

#+end_src
** ox
*** Github Flavored Markdown [[https://github.com/larstvei/ox-gfm][ox-gfm]]
#+begin_src emacs-lisp :tangle yes
  (leaf ox-gfm
    :ensure t)
#+end_src
* ターミナル
** [[https://github.com/szermatt/mistty][mistty]]
#+begin_src emacs-lisp :tangle yes
  (leaf mistty
    :doc "Shell/Comint alternative based on term.el."
    :tag "unix" "convenience" "emacs>=29.1"
    :ensure t)
#+end_src
* ユースケース
** 特定のバッファーのポイントを記録してどこからでもその位置にジャンプする
- =C-x r SPC r=(point-to-register) ポイントの記録
- =C-x r j r=(jump-to-register) 記録したポイントへジャンプ
https://ayatakesi.github.io/emacs/25.1/Position-Registers.html#Position-Registers
* Footer
#+begin_src emacs-lisp :tangle yes
  (provide 'init)

  ;;; init.el ends here
#+end_src
